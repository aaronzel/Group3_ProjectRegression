---
title: "Project_2"
author: "Sanjeev's SupeRstars: Aaron Zelmanov, Muhammad Hafizudeen Mohamad Saman, Nakul Chadha, Kendall Cohen, Michael Geraci"
date: "2/21/2021"
output:
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

data <- read.csv("ProjectA_Listings2013.csv")
library("ggplot2")
library("stats")
library("dplyr")
library("MASS")
library("gmodels")
library("rcompanion")

str(data)
summary(data) 

#factorize 
data$loan_status <- as.factor(data$loan_status)
data$total_open_revolving_accounts <- as.factor(data$loan_status_description)
data$prosper_score <- as.factor(data$prosper_score)
data$income_range <- as.factor(data$income_range)
data$income_range_description <- as.factor(data$income_range_description)
data$income_verifiable <- as.factor(data$income_verifiable)
data$employment_status_description <- as.factor(data$employment_status_description)
data$occupation <- as.factor(data$occupation)
data$borrower_state <- as.factor(data$borrower_state)
data$lender_indicator <- as.factor(data$lender_indicator)
data$is_homeowner <- as.factor(data$is_homeowner)

data$default <- ifelse(data$loan_status == 3, 1, 0)
#remove observations with NA's
any(is.na(data$months_employed))
any(is.na(data$installment_balance))
data <- data[complete.cases(data), ]
```

## {.tabset}
### Introduction 
**Context:** We are working with the ProjectA_Listings2013.csv dataset to better understand loans, interest rates, and defaults. This dataset includes information about: rates, balances, customer types, payments , defaults, etc.

**Audience:** Investors who are interested in taking advantage of arbitrage opportunities 

**Key Question:** Are there elements that the market does not consider a risk factor - but it actually is? Looking in the opposite direction - are there elements that market considers a risk factor but actually it isn’t?


### Basic Exploration 

The goal of this analysis is to identify arbitrage opportunities. We want to look if there are elements that the market does not consider a risk factor - but they actually are, or if there are elements that market considers a risk factor but actually they aren’t. This way, we can construct a way to build portfolios that have positive returns with zero net investment by taking advantage of the inefficiencies in the market.

But first, lets start by looking at the data as a whole. The two most important responses that we wanted to look at are the interest rates and the loan status - whether the borrower defaults or not. Correlations between the two responses and other variables can be helpful in determining which variable is significant in determining the interest rate or whether a borrower defaults. 

```{r, warning = FALSE}
correlationsRates <- as.data.frame(cor(data[sapply(data, function(x) is.numeric(x))])[4,])
correlationsRates %>% ggplot(aes(x=reorder(rownames(correlationsRates), correlationsRates[,1]), y=correlationsRates[,1])) + 
  geom_bar(stat = 'identity') + ggtitle("Correlations with Interest Rate") + labs(x="Variables", y="Correlation") + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))


correlationsDefault <- as.data.frame(cor(data[sapply(data, function(x) is.numeric(x))])[,35])
correlationsDefault %>% ggplot(aes(x=reorder(rownames(correlationsDefault)[], correlationsDefault[,1]), y=correlationsDefault[,1])) + 
  geom_bar(stat = 'identity') + ggtitle("Correlations with Default") + labs(x="Variables", y="Correlation") + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 90))
```

The graphs above show the correlation between the two responses of interest against other variables in the dataset. The leftmost variables are the variables that move in the opposite direction of the variables of interest, ordered in decreasing magnitude, while the rightmost variables are the ones that move in the same direction as the variables of interest, ordered in increasing magnitude. With this graph, we get to see which variables might be good in interpreting the responses. 

We have to note that the magnitude of the correlation is what matters in predicting which variables have a significant impact on the response variables. Negative correlations with high magnitude is likely to produce more predictive power than variables with almost zero correlation with the response.

<br />
<br />
Now, lets take a further look into the variables potentially have a significant effect on the responses.

```{r}
ggplot(data=data, aes(x=amount_funded, y = borrower_rate, colour=borrower_rate)) + geom_jitter(alpha = 0.25) + xlab("Amount Funded") + ylab("Borrower Rate") + ggtitle("Borrower Rate vs Amount Funded") + theme(plot.title = element_text(hjust = 0.5))
```

The data shows that as the amount funded increases, the borrower rate decreases.

```{r, warning = FALSE}
ggplot(data=data, aes(x=as.logical(default), y = borrower_rate, colour=borrower_rate)) + geom_boxplot() + xlab("Defaulted") + ylab("Borrower Rate") + ggtitle("Borrower Rate vs Default Status") + theme(plot.title = element_text(hjust = 0.5))
```

The data above shows that people who defaulted received higher borrowing rate. This is due to the fact that the lender charged the borrower for the credit risk that they took. The more likely the person is to default, the more that the borrower needs to pay so that in case the borrower defaults, the extra rate that the lender charged can cover a portion of the loss from the default.

```{r}
baseplot <- ggplot(data = data, aes(x=bankcard_utilization, y = borrower_rate, colour=borrower_rate)) + xlab("Bankcard Utilization") + ylab ("Borrower Rate") + ggtitle("Borrower Rate vs Bankcard Utilization") + theme(plot.title = element_text(hjust = 0.5))
baseplot+geom_smooth()
```

In the graph above, we can see that the borrower rate increases as the bank card utilization increases. This is most likely due to reason that people who utilize bank card a lot are seen as financially distressed and more likely to default. therefore the credit risk is higher on these people. However, we can also see that when the bank card utilization is fairly low, the borrower rate actually decreases as the utilization increases. This might be because the bank encourages some level of utilization of the card by offering incentives to lower the borrowing rate to customers who utilize credit card until a certain point.

### Linear Regression 

See below for a linear model determining how interest rates for loans are determined. We will create and run the model, analyze credit risks, and then proceed to analyze the model. 

```{r}
set.seed(123)

test_set <- sample(1:nrow(data), 0.2 * nrow(data))

data_train <- data[-test_set, ]
data_test <- data[test_set, ]

data_train_labels <- data[-test_set, "borrower_rate"]
data_test_labels <- data[test_set, "borrower_rate"]

lm.model <- lm(borrower_rate ~ principal_balance + amount_funded + listing_term + listing_monthly_payment + listing_category_id +  current_delinquencies + inquiries_last6_months + bankcard_utilization + revolving_balance + revolving_available_percent + delinquencies_over30_days + is_homeowner + loan_status + prosper_rating, data = data_train)
summary(lm.model)
```
<br />
*Linear Regression Model Analysis* 

We see that the model itself - the argument that the borrower rate has a significant relationship with the above variables included in the model - is in fact statistically significant (model p value < 0.05). These predictor variables explain about 94.5% of the variance in borrower rates, as as shown by the R-Squared value. This means that most of the key determinants of the borrower rate are included in the model. After our first iteration of the model, we learned that certain variables, such as delinquencies in the past year and total inquiries, were not significant and thus were removed. We can interpret the model by saying when principle balance goes up by 1, all else equal, the interest rate decreases by -4.087e-5. Additionally, when the amount funded increases by 1, the interest rate decreases by -1.125e-4. Similar analysis applies to each variable based on the coefficient estimate values. 

In summary: 
The following variables have a positive relationship with borrower rate (when this predictor variable goes up, so does interest rate): listing_term, listing_monthly_payment,  listing_category_id, current_delinquencies, inquiries_last6_months, bankcard_utilization, delinquencies_over30_days, loan status 2 and 3, and prosper ratings B C D E and HR. The market considers these factors "credit risks", and thus they raise the interest rate.  

The following variables have a negative relationship with borrower rate (when this predictor variable goes up, interest rate goes down): principal_balance, amount_funded, revolving_balance, revolving_available_percent, is_homeownerTRUE, loan_status4, and prosper_ratingAA. The market does not consider these factors "credit risks", rather the opposite. 

```{r}
# Plot the linear regression model 
plot(lm.model)

# Plot the accuracy graph
accuracy(list(lm.model), plotit = TRUE, digits = 3)
```
<br />
*Linear Regression Visualization Analysis*

Residual vs Fitted: The first graph displays if the mean residual value for every fitted value is close to 0. It shows if residuals have non-linear patterns. Because the red line is practically at 0, the model is sufficient. 

Normal Q-Q: This is a probability plot that shows if residuals are normally distributed. If you see between -2 and 2 (2 standard deviations above and below mean), the line is practically straight along y = x. This is favorable.

Scale Location: The scale-location plot shows if residuals are spread equally along the ranges of predictors. There is a bit of a peak in the middle, indicating that there are more points in the middle and the data converges around the mean. 

Residuals vs Leverage: This plot helps find influential cases (outliers) if any exist. This graph shows us that in our model, many of the outliers have standard residuals below 0, which is why the line falls downward. This means there are a small number of data points that are more influential in our model than others. The spots outside the dashed line (Cooks Distance) can be influential against the regression line. The regression would be changed if we exclude those cases. 

Model 1: This is the accuracy model. This accuracy model indicates that for the most part, our model is accurate. 

### Logistic Regression

See below for a logistic model determining what causes loan defaults. We will create and run the model, analyze default risks, and then proceed to analyze the model.

```{r, warning=FALSE}
data_train_labels_2 <- data[-test_set, "default"]
data_test_labels_2 <- data[test_set, "default"]

#logisticM1 <- glm (default ~ number_of_days + principal_balance + amount_funded + borrower_rate + listing_term + listing_monthly_payment + prosper_score + listing_category_id + income_range + stated_monthly_income + income_verifiable + dti_wprosper_loan + months_employed + monthly_debt + current_delinquencies + delinquencies_last7_years + public_records_last10_years + public_records_last12_months + credit_lines_last7_years + inquiries_last6_months + now_delinquent_derog + total_trade_items + amount_delinquent + current_credit_lines + open_credit_lines + bankcard_utilization + installment_balance + real_estate_balance + revolving_balance + real_estate_payment + revolving_available_percent + total_inquiries + satisfactory_accounts + was_delinquent_derog + delinquencies_over30_days + delinquencies_over60_days + delinquencies_over90_days + is_homeowner, data = data_train, family = "binomial") #all valid variables 
#summary(logisticM1)

#logisticM2 <- step(logisticM1)
#summary(logisticM2)

logisticM3 <- glm(default ~ number_of_days + principal_balance + borrower_rate + listing_term + stated_monthly_income + total_inquiries + was_delinquent_derog + principal_balance * listing_term + principal_balance * stated_monthly_income + principal_balance * total_inquiries + amount_funded * stated_monthly_income + I(number_of_days^2) + I(principal_balance^2) + I(amount_funded^2), data = data_train, family = "binomial")
summary(logisticM3)

test_pred_2 <- predict(logisticM3, newdata = data_test, type = "response")
predicted_results <- ifelse(test_pred_2 > 0.15, 1, 0) 
CrossTable(x = data_test_labels_2, y = predicted_results, prop.chisq=FALSE)

accuracy_logit1 <- (6359 + 4)/6660
accuracy_logit2 <- (6314+17)/6660
accuracy <- round(c(accuracy_logit1,accuracy_logit2),3)

error_logit1 <- 1-accuracy_logit1
error_logit2 <- 1-accuracy_logit2
error <- round(c(error_logit1, error_logit2),3)

sensitivity_logit1 <- 4/300
sensitivity_logit2 <- 17/300
sensitivity <- round(c(sensitivity_logit1, sensitivity_logit2),3)

specificity_logit1 <- 6359/6360
specificity_logit2 <- 6314/6360
specificity <- round(c(specificity_logit1,specificity_logit2),3)

precision_logit1 <- 4/5
precision_logit2 <- 17/63
precision <- round(c(precision_logit1,precision_logit2),3)

model <- c("Old Model", "New Model")
logit_metrics.df <- data.frame(model, accuracy, error, sensitivity, specificity, precision)
logit_metrics.df
```
<br />
*Logistic Regression Model Analysis*

Evaluation of Coefficients: From our logistic regression model, we essentially see that the magnitude of the loan is the greatest risk of default. This means that the the longer the loan is, the greater the principal balance, the borrower rate, and the amount funded all increase the likelihood of a default. Total inquiries interestingly also positively affected the likelihood of a default. Perhaps if someone is having difficulty paying their interest, they are more likely to ask for help. Stated monthly income had a negative effect on the likelihood of default. 

Evaluation of Confusion Matrix: In our initial model, our accuracy was very high at rate of ~96%. However a big problem with this model was the sensitivity metric which had a rate of ~1%. What this means is that out of all data points in our test set that defaulted, we only correctly predicted ~1%. A reason for this may be that our data is filled with points that overwhelmingly did not default ~96%. However, we believed that for this model to be of any value to us we should increase our sensitivity rate even at the expense of accuracy. To do this we reduced the threshold at which our prediction would output default to >= 0.15. This improved the sensitivity of our model to 5.6% while only reducing our accuracy to 95%. We believe that this adjustment creates value for our model, although it does still struggle to identify defaults. We think this is because the dataset has minimal data about defaults and the logistic regression needs more default data to predict future cases accurately. 
```{r}
plot(logisticM3)
```

<br />

*Logistic Regression Visualization Analysis*

Residuals vs. Fitted:

Normal Q-Q:

Scale-Location:

Residuals vs. Leverage:








### Comparison/Arbitrage 

**Variables that are significant in the linear regression but not in the logistic regression currently affect a borrower's interest rate but actually shouldn't because may not be predictive of default. Let's explore:**

listing_monthly_payment, listing_category_id, current_delinquencies, inquiries_last6_months, bankcard_utilization, revolving_balance, revolving_available_percent, delinquencies_over30_days, is_homeowner, and prosper_rating are examples of such variables. listing_monthly_payment, listing_category_id, current_delinquencies, inquiries_last6_months, bankcard_utilization, delinquencies_over30_days, and non prosper_rating AA all increase interest rates despite not being predictive of actual defaults. Thus, it is likely that borrowers/loans that meet these conditions are being charged higher rates than they should. On the flip side, revolving_balance, revolving_available_percent, is_homeownerTRUE, and prosper_ratingAA all decrease interest rated despite not being predictive of actual defaults. Thus, it is likely that borrowers/loans that meet these conditions are being charged lower rates than they should. 

**Variables that are significant in the logistic regression but not in the linear regression currently affect a borrower's default likelihood but are not reflected in the interest rate charged. Let's explore:**

number_of_days, borrower_rate, stated_monthly_income, total_inquiries, and was_delinquent_derog are examples of such variables. They increase odds of default but aren't causing an increase in interest rates. Although some of these variables may be reflected through other similar variables in the linear model, it would be more accurate to use the variables that are most predictive of default. Thus, it is likely that borrowers/loans that meet these conditions are being charged lower rates than they should.      

**Variables that are significant in both the linear regression and logistic regression but show opposite outcomes affect a borrower's interest rate in the opposite direction that they should. Let's explore:**

principal_balance and amount_funded are examples of such variables. They decrease interest rates despite actually increasing odds of default. Thus, it is likely that borrowers/loans that meet these conditions are being charged lower rates than they should.      


### Conclusion 
